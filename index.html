
import React, { useState, useEffect, useMemo } from 'react';
import { 
  Calculator, 
  History, 
  Info, 
  AlertTriangle, 
  ChevronDown, 
  Trash2, 
  Save, 
  Utensils,
  Droplets,
  Scale
} from 'lucide-react';
import { INGREDIENTS, TIPS, WARNINGS } from './constants';
import { Ingredient, IngredientType, CalculationResult } from './types';
import { calculateToCups, calculateFromCups } from './services/calculator';

const App: React.FC = () => {
  const [selectedIngredient, setSelectedIngredient] = useState<Ingredient>(INGREDIENTS[0]);
  const [inputValue, setInputValue] = useState<string>('');
  const [inputUnit, setInputUnit] = useState<'g' | 'ml' | 'cup'>('g');
  const [history, setHistory] = useState<CalculationResult[]>([]);
  const [showHistory, setShowHistory] = useState(false);
  const [isSaved, setIsSaved] = useState(false);

  // Initialize input unit based on ingredient type
  useEffect(() => {
    if (selectedIngredient.type === IngredientType.LIQUID) {
      if (inputUnit === 'g') setInputUnit('ml');
    } else {
      if (inputUnit === 'ml') setInputUnit('g');
    }
  }, [selectedIngredient]);

  const resultPhrase = useMemo(() => {
    if (!inputValue || isNaN(Number(inputValue))) return '';
    const val = Number(inputValue);
    
    if (inputUnit === 'cup') {
      const converted = calculateFromCups(val, selectedIngredient.type);
      const unitLabel = selectedIngredient.type === IngredientType.DRY ? 'ØºØ±Ø§Ù…' : 'Ù…Ù„';
      return `${val} ÙƒØ§Ø³ Ø¹Ù†Ø¨Ø© â‰ˆ ${converted} ${unitLabel}`;
    } else {
      const phrase = calculateToCups(val, selectedIngredient.type);
      const unitLabel = inputUnit === 'g' ? 'ØºØ±Ø§Ù…' : 'Ù…Ù„';
      return `${val} ${unitLabel} Ù…Ù† ${selectedIngredient.ar} (${selectedIngredient.fr}) â‰ˆ ${phrase}`;
    }
  }, [inputValue, inputUnit, selectedIngredient]);

  const handleSave = () => {
    if (!resultPhrase) return;
    const newResult: CalculationResult = {
      id: Math.random().toString(36).substr(2, 9),
      ingredient: selectedIngredient,
      inputValue: Number(inputValue),
      inputUnit: inputUnit,
      outputValue: resultPhrase,
      timestamp: Date.now(),
    };
    setHistory([newResult, ...history]);
    setIsSaved(true);
    setTimeout(() => setIsSaved(false), 2000);
  };

  const clearHistory = () => {
    setHistory([]);
  };

  const randomTip = useMemo(() => TIPS[Math.floor(Math.random() * TIPS.length)], []);
  const randomWarning = useMemo(() => WARNINGS[Math.floor(Math.random() * WARNINGS.length)], []);

  return (
    <div className="min-h-screen pb-12 transition-all duration-300">
      {/* Header */}
      <header className="bg-[#5D4037] text-[#F5F5DC] py-8 px-4 shadow-xl text-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
          <div className="grid grid-cols-8 gap-2 rotate-12">
            {[...Array(64)].map((_, i) => (
              <Utensils key={i} size={48} />
            ))}
          </div>
        </div>
        <h1 className="arabic-title text-4xl md:text-5xl font-bold mb-2 relative z-10">Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p className="text-[#D4AF37] font-medium text-lg relative z-10">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¯ÙŠØ§Ù„ ÙƒØ§Ø³ Ø§Ù„Ø¹Ù†Ø¨Ø© ÙÙŠ ÙŠØ¯ÙŠÙƒ ğŸ‡²ğŸ‡¦</p>
      </header>

      <main className="max-w-2xl mx-auto px-4 -mt-6">
        {/* Calculator Card */}
        <div className="bg-white rounded-3xl shadow-2xl p-6 md:p-8 border-t-4 border-[#D4AF37] relative overflow-hidden">
          <div className="flex justify-between items-center mb-6">
             <div className="flex items-center gap-2 text-[#5D4037]">
                <Calculator className="text-[#D4AF37]" size={28} />
                <h2 className="text-xl font-bold">Ø¢Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
             </div>
             <button 
                onClick={() => setShowHistory(!showHistory)}
                className="text-[#5D4037] hover:text-[#D4AF37] transition-colors flex items-center gap-1 text-sm font-semibold"
             >
               <History size={18} />
               {showHistory ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„' : 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª'}
             </button>
          </div>

          <div className="space-y-6">
            {/* Ingredient Selector */}
            <div>
              <label className="block text-[#5D4037] text-sm font-bold mb-2">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…ÙƒÙˆÙ†:</label>
              <div className="relative">
                <select 
                  value={selectedIngredient.id}
                  onChange={(e) => setSelectedIngredient(INGREDIENTS.find(i => i.id === e.target.value)!)}
                  className="w-full bg-[#FDFBF7] border-2 border-[#E0D5C1] text-[#5D4037] rounded-xl py-3 px-4 appearance-none focus:outline-none focus:border-[#D4AF37] transition-all font-medium"
                >
                  {INGREDIENTS.map(ing => (
                    <option key={ing.id} value={ing.id}>
                      {ing.ar} ({ing.fr})
                    </option>
                  ))}
                </select>
                <ChevronDown className="absolute left-4 top-1/2 transform -translate-y-1/2 text-[#D4AF37]" size={20} />
              </div>
            </div>

            {/* Input Section */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-[#5D4037] text-sm font-bold mb-2">Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
                <input 
                  type="number" 
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  placeholder="0"
                  className="w-full bg-[#FDFBF7] border-2 border-[#E0D5C1] text-[#5D4037] rounded-xl py-3 px-4 focus:outline-none focus:border-[#D4AF37] transition-all text-center text-xl font-bold"
                />
              </div>
              <div>
                <label className="block text-[#5D4037] text-sm font-bold mb-2">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                <div className="flex bg-[#FDFBF7] border-2 border-[#E0D5C1] rounded-xl p-1">
                  {selectedIngredient.type === IngredientType.DRY ? (
                    <button 
                      onClick={() => setInputUnit('g')}
                      className={`flex-1 py-2 rounded-lg transition-all font-bold ${inputUnit === 'g' ? 'bg-[#5D4037] text-white' : 'text-[#5D4037]'}`}
                    >
                      ØºØ±Ø§Ù… (g)
                    </button>
                  ) : (
                    <button 
                      onClick={() => setInputUnit('ml')}
                      className={`flex-1 py-2 rounded-lg transition-all font-bold ${inputUnit === 'ml' ? 'bg-[#5D4037] text-white' : 'text-[#5D4037]'}`}
                    >
                      Ù…Ù„ (ml)
                    </button>
                  )}
                  <button 
                    onClick={() => setInputUnit('cup')}
                    className={`flex-1 py-2 rounded-lg transition-all font-bold ${inputUnit === 'cup' ? 'bg-[#5D4037] text-white' : 'text-[#5D4037]'}`}
                  >
                    ÙƒØ§Ø³
                  </button>
                </div>
              </div>
            </div>

            {/* Result Display */}
            {resultPhrase && (
              <div className="mt-8 p-6 bg-[#FDFBF7] rounded-2xl border-2 border-dashed border-[#D4AF37] text-center animate-in fade-in zoom-in duration-300">
                <p className="text-[#5D4037] text-lg font-bold mb-1">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‡ÙŠ:</p>
                <p className="text-2xl md:text-3xl font-bold text-[#5D4037] mb-4 arabic-title leading-relaxed">
                  {resultPhrase}
                </p>
                <div className="flex flex-col items-center gap-3">
                  <p className="text-green-600 font-medium flex items-center gap-1">
                    Ø§Ù„Ù„Ù‡ ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„ØµØ­Ø©ØŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ø¬Ø¯ ğŸ‘Œ
                  </p>
                  <button 
                    onClick={handleSave}
                    disabled={isSaved}
                    className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold transition-all shadow-md ${isSaved ? 'bg-green-100 text-green-700' : 'bg-[#D4AF37] text-[#5D4037] hover:bg-[#C09A30]'}`}
                  >
                    {isSaved ? <Utensils size={18} /> : <Save size={18} />}
                    {isSaved ? 'ØªÙ… Ø§Ù„Ø­ÙØ¸!' : 'Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨'}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* History Section */}
        {showHistory && (
          <div className="mt-6 bg-white rounded-3xl shadow-xl p-6 border-t-4 border-[#5D4037] animate-in slide-in-from-top duration-500">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold text-[#5D4037] flex items-center gap-2">
                <History className="text-[#D4AF37]" size={20} />
                Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
              </h3>
              {history.length > 0 && (
                <button 
                  onClick={clearHistory}
                  className="text-red-500 hover:text-red-700 transition-colors flex items-center gap-1 text-sm font-semibold"
                >
                  <Trash2 size={16} />
                  Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                </button>
              )}
            </div>
            
            <div className="space-y-3 max-h-60 overflow-y-auto custom-scroll px-1">
              {history.length === 0 ? (
                <p className="text-center py-8 text-gray-400 italic">Ø§Ù„Ø³Ø¬Ù„ Ø®Ø§ÙˆÙŠØŒ Ø¨Ø¯Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø¨Ø§!</p>
              ) : (
                history.map(item => (
                  <div key={item.id} className="bg-[#FDFBF7] p-3 rounded-xl border border-[#E0D5C1] text-right">
                    <div className="flex justify-between items-start mb-1">
                       <span className="text-[10px] text-gray-400">{new Date(item.timestamp).toLocaleTimeString('ar-MA')}</span>
                       <span className="text-xs font-bold text-[#D4AF37]">{item.ingredient.ar}</span>
                    </div>
                    <p className="text-[#5D4037] font-medium text-sm">{item.outputValue}</p>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* Extras: Tips & Warnings */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
          <div className="bg-[#F5F5DC] p-4 rounded-2xl border-r-4 border-[#D4AF37] shadow-sm flex items-start gap-3">
            <div className="bg-[#D4AF37] p-2 rounded-lg text-white">
              <Info size={20} />
            </div>
            <div>
              <h4 className="font-bold text-[#5D4037] mb-1">Ù†ØµÙŠØ­Ø© Ø°ÙƒÙŠØ©</h4>
              <p className="text-sm text-[#5D4037] leading-relaxed">{randomTip}</p>
            </div>
          </div>
          <div className="bg-orange-50 p-4 rounded-2xl border-r-4 border-orange-400 shadow-sm flex items-start gap-3">
            <div className="bg-orange-400 p-2 rounded-lg text-white">
              <AlertTriangle size={20} />
            </div>
            <div>
              <h4 className="font-bold text-orange-800 mb-1">Ø±Ø¯ Ø¨Ø§Ù„Ùƒ</h4>
              <p className="text-sm text-orange-800 leading-relaxed">{randomWarning}</p>
            </div>
          </div>
        </div>
      </main>

      {/* Floating Action Button for Contact/About */}
      <footer className="fixed bottom-6 left-6 flex gap-3">
        <div className="bg-white/90 backdrop-blur-sm p-3 rounded-full shadow-lg border border-[#D4AF37] text-[#5D4037] flex items-center gap-4 px-6 animate-bounce">
           <div className="flex items-center gap-2">
             <Scale size={18} className="text-[#D4AF37]" />
             <span className="text-sm font-bold">110g Ù†ÙˆØ§Ø´Ù</span>
           </div>
           <div className="w-px h-4 bg-[#D4AF37]/30"></div>
           <div className="flex items-center gap-2">
             <Droplets size={18} className="text-[#D4AF37]" />
             <span className="text-sm font-bold">170ml Ø³ÙˆØ§Ø¦Ù„</span>
           </div>
        </div>
      </footer>
    </div>
  );
};

export default App;
